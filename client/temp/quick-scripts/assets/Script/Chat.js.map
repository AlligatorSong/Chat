{"version":3,"sources":["Chat.js"],"names":["account","window","cc","Class","extends","Component","properties","scrollView","ScrollView","viewContent","Layout","chatItem","Prefab","listItem","returnBtn","Button","enterBtn","enterText","EditBox","showBtn","nameLab","Label","roomLab","tipLayer","Node","listLayer","listContent","tipLab","toLab","showTip","word","stopAllActions","y","tipPosY","height","string","seq","sequence","moveBy","p","delayTime","runAction","moveList","isLeft","isLeftList","width","x","listPosX","initList","memGroup","getMembers","node","removeAllChildren","addOneForList","key","element","createOneForList","name","item","instantiate","label","getComponent","self","on","event","addChild","removeOneForList","items","children","isRemove","newToName","hasOwnProperty","removeFromParent","onLoad","getUserName","getUserChannel","pomelo","data","user","wordAdd","addMember","kickMember","addChatItem","reason","removeAllListeners","director","loadScene","update","dt","replaceString","wordArray","arguments","split","index","length","RichText","now","Date","to","target","Format","from","msg","maskSizeH","getChildByName","curContentHeight","stopAutoScroll","bolBottomToTop","VerticalDirection","BOTTOM_TO_TOP","verticalDirection","scrollToBottom","scrollToTop","clickShowBtn","clickEnterBtn","undefined","route","request","rid","content","clickReturnBtn","disconnect"],"mappings":"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","file":"Chat.js","sourceRoot":"../../../../assets/Script","sourcesContent":["var account = window.account\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        scrollView: cc.ScrollView,\n        viewContent: cc.Layout,\n        chatItem: cc.Prefab,\n        listItem: cc.Prefab,\n        returnBtn: cc.Button,\n        enterBtn: cc.Button,\n        enterText: cc.EditBox,\n        showBtn: cc.Button,\n        nameLab: cc.Label,\n        roomLab: cc.Label,\n        tipLayer: cc.Node,\n        listLayer: cc.Node,\n        listContent: cc.Layout,\n        tipLab: cc.Label,\n        toLab: cc.Label,\n    },\n\n    showTip: function (word) {\n        this.tipLayer.stopAllActions();\n        this.tipLayer.y = this.tipPosY;\n        let height = this.tipLayer.height;\n        this.tipLab.string = 'tip:\\n\\t ' + word;\n        let seq = cc.sequence(\n            cc.moveBy(0.6, cc.p(0, height)),\n            cc.delayTime(1),\n            cc.moveBy(0.6, cc.p(0, -height))\n        );\n        this.tipLayer.runAction(seq);\n    },\n\n    moveList: function (isLeft) {\n        isLeft = isLeft || this.isLeftList;\n        this.listLayer.stopAllActions();\n        let width = this.listLayer.width;\n        if (isLeft) {\n            width = -width;\n        } else {\n            this.listLayer.x = this.listPosX;\n        };\n        this.listLayer.runAction(cc.moveBy(0.6, cc.p(width, 0)));\n        this.isLeftList = !isLeft;\n    },\n\n    initList: function () {\n        let memGroup = account.getMembers();\n        this.listContent.node.removeAllChildren();\n        this.addOneForList('All');\n        for (const key in memGroup) {\n            if (memGroup[key]) {\n                const element = memGroup[key];\n                this.addOneForList(element);\n            }\n        };\n    },\n\n    createOneForList: function (name) {\n        let item = cc.instantiate(this.listItem);\n        let label = item.getComponent(cc.Label);\n        label.string = name;\n        let self = this;\n        item.on('touchend', function (event) {\n            self.toLab.string = name;\n            self.moveList(true);\n        }, self);\n        return item\n    },\n\n    addOneForList: function (name) {\n        let item = this.createOneForList(name);\n        this.listContent.node.addChild(item);\n    },\n\n    removeOneForList: function (name) {\n        let items = this.listContent.node.children;\n        let isRemove = false;\n        let newToName;\n        for (const key in items) {\n            if (items.hasOwnProperty(key)) {\n                const item = items[key];\n                let string = item.getComponent(cc.Label).string;\n                if (string === name) {\n                    item.removeFromParent();\n                    break;\n                    \n                }else if(!newToName){\n                    newToName = name;\n                }\n            };\n        };\n        if (name === this.toLab.string){\n            this.toLab.string = newToName || 'All';\n        };\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        this.isLeftList = false;\n        // this.createList()\n        this.nameLab.string = 'name:' + account.getUserName();\n        this.roomLab.string = 'room:' + account.getUserChannel();\n        //\n        this.tipPosY = this.tipLayer.y;\n        this.listPosX = this.listLayer.x;\n\n        let self = this;\n        pomelo.on('onAdd', function (data) {\n            var user = data.user;\n            let wordAdd = 'wellcome ' + user + ' join room';\n            self.showTip(wordAdd);\n            account.addMember(user)\n            self.addOneForList(user)\n        });\n        pomelo.on('onLeave', function (data) {\n            var user = data.user;\n            let wordAdd = user + ' leave room';\n            self.showTip(wordAdd);\n            account.kickMember(user)\n            self.removeOneForList(user)\n        });\n        // 监听\"onChat\", 接收消息\n        pomelo.on('onChat', function (data) {\n            self.addChatItem(data)\n        });\n\n        //当从聊天断开时\n        pomelo.on('disconnect', function (reason) {\n            pomelo.removeAllListeners();\n            self.tipLayer.stopAllActions();\n            cc.director.loadScene('load');\n        });\n\n        this.initList()\n    },\n\n    // called every frame\n    update: function (dt) {\n    },\n\n    // arguments[0]为要替换的目标string\n    // [1]时间、[2]from、[3]to、[4]content\n    replaceString: function () {\n        let wordArray = arguments[0].split('@');\n        let word = '';\n        for (let index = 0; index < wordArray.length - 1; index++) {\n            const element = wordArray[index];\n            word = word + element + arguments[index + 1];\n        }\n        return word;\n    },\n\n    addChatItem: function (data) {\n        let item = cc.instantiate(this.chatItem);\n        let label = item.getComponent(cc.RichText);\n        let now = new Date();\n        let word = '<color=#00ff00>@</c><color=#0fffff><br/>@</c><color=#00ff00> says to</c><color=#0fffff> @ :<br/>@';\n        let to = (data.target === '*' ? 'All' : data.target);\n        word = this.replaceString(\n            word,\n            now.Format('yyyy-MM-dd hh:mm:ss'),\n            data.from,\n            to,\n            data.msg\n        );\n        label.string = word;\n        this.viewContent.node.addChild(item);\n\n        let maskSizeH = this.scrollView.node.getChildByName('view').height;\n        let curContentHeight = this.viewContent.node.height + item.height;\n        if (maskSizeH >= curContentHeight) {\n            return;\n        }\n        this.scrollView.stopAutoScroll()\n        let bolBottomToTop = cc.Layout.VerticalDirection.BOTTOM_TO_TOP == this.viewContent.verticalDirection;\n        if (!bolBottomToTop) {\n            if (this.viewContent.node.y >= (this.viewContent.node.height - 2 * maskSizeH) / 2) {\n                this.scrollView.scrollToBottom();\n            } else {\n                this.viewContent.node.y -= item.height / 2;\n            }\n        } else {\n            if (this.viewContent.node.y <= -(this.viewContent.node.height - 2 * maskSizeH) / 2) {\n                this.scrollView.scrollToTop();\n            } else {\n                this.viewContent.node.y += item.height / 2;\n            }\n        }\n    },\n\n    //arguments[1]eventData\n    clickShowBtn: function () {\n        this.moveList();\n    },\n\n    clickEnterBtn: function () {\n        if (this.enterText.string == undefined\n            || this.enterText.string == ''\n            || this.enterText.string == null) {\n            return\n        }\n        let route = \"chat.chatHandler.send\",\n            target = (this.toLab.string === 'All' ? '*' : this.toLab.string),\n            msg = this.enterText.string;\n        let self = this;\n        pomelo.request(route, {\n            rid: self.roomLab.string,\n            content: msg,\n            from: self.nameLab.string,\n            target: target\n        }, function (data) {\n            self.enterText.string = '';\n        });\n\n    },\n\n    clickReturnBtn: function () {\n        pomelo.disconnect();\n    },\n});\n"]}